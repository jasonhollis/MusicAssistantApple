version: '3.8'

services:
  music-assistant:
    image: ghcr.io/music-assistant/server:latest
    container_name: music-assistant
    restart: unless-stopped
    ports:
      # Internal port for nginx reverse proxy
      - "127.0.0.1:8095:8095"
    environment:
      # Music Assistant configuration
      TZ: America/Los_Angeles
      # Optional: Add authentication token if needed
      # MA_AUTH_TOKEN: your_token_here
    volumes:
      # Store configuration and cache in persistent volume
      - music_assistant_data:/home/music-assistant/.config
      # Media library paths (update these to your actual paths)
      - /mnt/music:/mnt/music:ro
      - /mnt/podcasts:/mnt/podcasts:ro
    networks:
      - music_network
    depends_on:
      - oauth-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  oauth-server:
    image: python:3.11-slim
    container_name: oauth-server
    restart: unless-stopped
    ports:
      # Internal port for nginx reverse proxy
      - "127.0.0.1:8096:8096"
    working_dir: /app
    command: python oauth_server.py
    environment:
      # OAuth configuration
      ALEXA_CLIENT_ID: amazon-alexa
      ALEXA_CLIENT_SECRET: ${ALEXA_CLIENT_SECRET}
      OAUTH_PORT: "8096"
      MA_HOST: music-assistant
      MA_PORT: 8095
    volumes:
      # OAuth server code and configuration
      - ./oauth_server.py:/app/oauth_server.py:ro
      - ./oauth_clients.json:/app/oauth_clients.json:ro
    networks:
      - music_network
    depends_on:
      music-assistant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  music_assistant_data:
    driver: local

networks:
  music_network:
    driver: bridge
