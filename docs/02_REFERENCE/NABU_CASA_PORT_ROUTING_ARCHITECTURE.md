# Nabu Casa Port Routing Architecture Reference
**Purpose**: Quick reference for understanding Nabu Casa custom domain port routing capabilities and limitations
**Audience**: System administrators, developers implementing public OAuth endpoints
**Layer**: 02_REFERENCE
**Related**:
- [Nabu Casa Custom Domain Test Plan](../05_OPERATIONS/NABU_CASA_CUSTOM_DOMAIN_TEST_PLAN.md)
- [Nabu Casa vs Tailscale Decision Tree](../05_OPERATIONS/NABU_CASA_VS_TAILSCALE_DECISION_TREE.md)

---

## Intent

Provide quick-lookup reference for Nabu Casa's custom domain routing behavior, port forwarding capabilities, and architectural constraints. This document answers: "What traffic can Nabu Casa custom domains route to my Home Assistant instance?"

---

## Nabu Casa Custom Domain Overview

### What It Is
- **Service**: Nabu Casa Cloud (Home Assistant Cloud)
- **Purpose**: Expose Home Assistant instance via custom domain without port forwarding
- **Cost**: $6.50/month (includes remote access, Alexa/Google Assistant integration, SSL certificates)
- **Infrastructure**: nginx-based reverse proxy hosted by Nabu Casa

### How It Works
```
Internet Request
  ‚Üì
Custom Domain (boxhillsouth.jasonhollis.com)
  ‚Üì DNS CNAME
Nabu Casa Proxy (0gdzommh4w1tug2s97xnn9spylzmkkbs.ui.nabu.casa)
  ‚Üì Encrypted tunnel
Home Assistant Instance (internal IP)
  ‚Üì Port routing
Home Assistant Services (ports 8123, 8096, etc.)
```

---

## Port Routing Behavior

### Standard Port 8123 (Home Assistant Web UI)

**Default Behavior**: ALWAYS works via custom domain

**Configuration**: Zero configuration required (automatic)

**URL Mapping**:
```
https://boxhillsouth.jasonhollis.com/
  ‚Üì
Nabu Casa Proxy
  ‚Üì
http://homeassistant.local:8123/
```

**Technical Details**:
- **Protocol**: HTTPS (SSL termination at Nabu Casa)
- **Certificate**: Auto-generated by Nabu Casa (Let's Encrypt)
- **Renewal**: Automatic (no user intervention)
- **WebSocket**: Supported (required for HA frontend)
- **Performance**: ~50-100ms latency added (Nabu Casa proxy overhead)

**Use Cases**:
- Home Assistant web UI access
- HA API endpoints (`/api/*`)
- HA authentication endpoints (`/auth/*`)
- Lovelace dashboard
- Add-on web interfaces exposed through HA ingress

---

### Non-Standard Ports (8096, 8080, etc.)

**Status**: UNKNOWN (requires testing)

**Expected Behavior**: Likely blocked or not routed by default

**Possible Outcomes**:

#### Outcome A: Port-Specific Routing Works
**URL Format**: `https://boxhillsouth.jasonhollis.com:8096/`

**If Supported**:
- Nabu Casa nginx config allows arbitrary ports
- Custom domain routes to specified port on HA instance
- SSL certificate valid for custom domain on all ports
- **Likelihood**: LOW (uncommon for reverse proxies)

**Test Command**:
```bash
curl -I https://boxhillsouth.jasonhollis.com:8096/authorize
```

**Expected Response** (if works):
- **Status**: 200 OK or 401 Unauthorized
- **Headers**: SSL certificate valid, OAuth server responds

---

#### Outcome B: Port-Specific Routing Blocked
**Symptom**: Connection refused, timeout, or 502 Bad Gateway

**If Blocked**:
- Nabu Casa nginx config only forwards port 8123 traffic
- Non-standard ports not in proxy configuration
- Custom domain SSL certificate not valid for :8096
- **Likelihood**: HIGH (standard reverse proxy behavior)

**Test Command**:
```bash
curl -I https://boxhillsouth.jasonhollis.com:8096/authorize
```

**Expected Response** (if blocked):
- **Connection refused**: Port not forwarded by proxy
- **Timeout**: Firewall blocking non-standard ports
- **502 Bad Gateway**: Proxy forwards but target unreachable
- **SSL error**: Certificate not valid for port 8096

---

### Path-Based Routing (Alternative Approach)

**Concept**: Use URL paths instead of ports to route to different services

**URL Format**: `https://boxhillsouth.jasonhollis.com/oauth/authorize`

**Architecture**:
```
https://boxhillsouth.jasonhollis.com/oauth/*
  ‚Üì
Nabu Casa Proxy (port 8123)
  ‚Üì
Home Assistant (port 8123)
  ‚Üì
nginx/Caddy Add-on (reverse proxy)
  ‚Üì
http://music-assistant:8096/*
```

**Configuration Required**:
- **Inside HA**: Install nginx or Caddy add-on
- **Proxy Rules**: Map `/oauth/*` to `music-assistant:8096/*`
- **Nabu Casa**: No changes (routes to port 8123 as normal)

**Advantages**:
‚úÖ Works with standard Nabu Casa routing (port 8123)
‚úÖ No dependency on non-standard port support
‚úÖ Clean URLs (paths instead of ports)
‚úÖ Flexible routing (can proxy multiple services)

**Disadvantages**:
‚ö†Ô∏è Requires nginx/Caddy add-on installation
‚ö†Ô∏è Additional configuration layer
‚ö†Ô∏è Proxy rules must be maintained

---

## Architectural Constraints

### SSL Certificate Scope

**Nabu Casa Certificate**:
- **Issuer**: Let's Encrypt
- **Domain**: `boxhillsouth.jasonhollis.com`
- **Wildcard**: NO (specific subdomain only)
- **Port Scope**: Typically port 443 only (HTTPS standard)

**Implication**:
- Custom domain certificate may not be valid for `boxhillsouth.jasonhollis.com:8096`
- Non-standard ports may require separate SSL termination
- Path-based routing avoids this issue (all traffic on port 443 ‚Üí 8123)

---

### nginx Proxy Configuration

**Nabu Casa Infrastructure**:
- **Software**: nginx reverse proxy
- **Configuration**: NOT user-accessible (managed by Nabu Casa)
- **Customization**: Limited to Nabu Casa UI settings (domain name, remote access toggle)

**Typical nginx Proxy Behavior**:
```nginx
# Standard reverse proxy (expected Nabu Casa config)
server {
    listen 443 ssl;
    server_name boxhillsouth.jasonhollis.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://[HA_INSTANCE]:8123;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for Home Assistant
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**Observation**:
- Only `location /` block (all paths to port 8123)
- No port-specific routing (e.g., `:8096`)
- No path-based routing to other ports (e.g., `/oauth/` to `:8096`)

**Conclusion**:
- Port 8123 routing: Guaranteed
- Port 8096 routing: Unlikely (requires explicit nginx config)
- Path-based routing: Possible only with nginx add-on inside HA

---

### Traffic Flow Layers

**Layer 1: Internet ‚Üí Nabu Casa Proxy**
- **Protocol**: HTTPS (port 443)
- **DNS**: `boxhillsouth.jasonhollis.com` ‚Üí CNAME ‚Üí `0gdzommh4w1tug2s97xnn9spylzmkkbs.ui.nabu.casa`
- **SSL Termination**: At Nabu Casa proxy
- **Authentication**: None (public endpoint)

**Layer 2: Nabu Casa Proxy ‚Üí Home Assistant**
- **Protocol**: Encrypted tunnel (proprietary Nabu Casa protocol)
- **Port**: 8123 (Home Assistant web interface)
- **SSL**: Re-encrypted in tunnel
- **Authentication**: Nabu Casa subscription validation

**Layer 3: Home Assistant ‚Üí Internal Services**
- **Protocol**: HTTP (internal Docker network)
- **Routing**: Docker DNS (e.g., `music-assistant:8096`)
- **SSL**: None (internal traffic, trusted network)
- **Authentication**: Service-specific (OAuth, API keys, etc.)

---

## Port Routing Test Matrix

| Port | Service | Expected Nabu Casa Support | Test Result |
|------|---------|---------------------------|-------------|
| **8123** | Home Assistant Web UI | ‚úÖ YES (guaranteed) | ‚úÖ Works |
| **8096** | Music Assistant OAuth | ‚ùì UNKNOWN (test required) | üî¨ Testing |
| **8080** | Custom web service | ‚ùì UNKNOWN | Not tested |
| **1880** | Node-RED | ‚ùì UNKNOWN | Not tested |
| **3000** | Grafana | ‚ùì UNKNOWN | Not tested |
| **8200** | Portainer | ‚ùì UNKNOWN | Not tested |

**Key**:
- ‚úÖ Confirmed working
- ‚ùå Confirmed blocked
- ‚ùì Unknown (requires testing)
- üî¨ Currently under test

---

## Known Workarounds

### Workaround 1: Reverse Proxy Inside Home Assistant

**Approach**: Install nginx/Caddy add-on to proxy paths to non-standard ports

**Configuration**:
```
Nabu Casa (port 8123) ‚Üí HA ‚Üí nginx Add-on ‚Üí music-assistant:8096
```

**URL Mapping**:
```
https://boxhillsouth.jasonhollis.com/oauth/authorize
  ‚Üì
nginx location /oauth/authorize
  ‚Üì
proxy_pass http://music-assistant:8096/authorize
```

**Pros**:
- ‚úÖ Uses Nabu Casa custom domain
- ‚úÖ Works with standard port 8123 routing
- ‚úÖ Flexible path-to-port mapping

**Cons**:
- ‚ö†Ô∏è Requires nginx/Caddy add-on
- ‚ö†Ô∏è Additional configuration layer
- ‚ö†Ô∏è Proxy rules maintenance

**Implementation**: See [Nabu Casa vs Tailscale Decision Tree - Option B1](../05_OPERATIONS/NABU_CASA_VS_TAILSCALE_DECISION_TREE.md#option-b1-reverse-proxy-within-home-assistant)

---

### Workaround 2: Home Assistant Ingress

**Approach**: Use Home Assistant's built-in add-on ingress feature

**Requirements**:
- Service must be configured as Home Assistant add-on
- Add-on must support ingress panel configuration

**Configuration** (in add-on `config.yaml`):
```yaml
panel_icon: mdi:music
panel_title: Music Assistant
ingress: true
ingress_port: 8096
```

**URL Mapping**:
```
https://boxhillsouth.jasonhollis.com/api/hassio_ingress/[addon_slug]/authorize
```

**Pros**:
- ‚úÖ No nginx add-on required
- ‚úÖ Built-in Home Assistant feature
- ‚úÖ Works with Nabu Casa port 8123

**Cons**:
- ‚ö†Ô∏è Requires add-on to support ingress
- ‚ö†Ô∏è Long URL paths (includes `/api/hassio_ingress/`)
- ‚ö†Ô∏è May not work for OAuth (redirect URI complexity)

**Applicability**: Limited (OAuth redirect URIs may not support ingress paths)

---

### Workaround 3: Alternative Public Exposure (Tailscale Funnel)

**Approach**: Use Tailscale Funnel instead of Nabu Casa for OAuth endpoints

**Architecture**:
```
Tailscale Funnel (*.ts.net) ‚Üí Tailscale Container ‚Üí music-assistant:8096
```

**URL**:
```
https://a0d7b954-tailscale.ts.net/oauth/authorize
```

**Pros**:
- ‚úÖ Independent from Nabu Casa (no port routing constraints)
- ‚úÖ Direct routing to port 8096
- ‚úÖ Automatic SSL via Tailscale

**Cons**:
- ‚ö†Ô∏è Doesn't use Nabu Casa custom domain
- ‚ö†Ô∏è Generic *.ts.net subdomain (not custom domain)
- ‚ö†Ô∏è Requires socat/proxy process management

**Implementation**: See [Tailscale Funnel Configuration](../05_OPERATIONS/TAILSCALE_FUNNEL_CONFIGURATION_HA.md)

---

## Common Scenarios

### Scenario 1: Expose OAuth Server on Port 8096

**Requirement**: Public HTTPS endpoint for OAuth authorization

**Options**:
1. **Test port 8096 routing** ‚Üí If works, use direct URL
2. **Use reverse proxy** ‚Üí Path-based routing via nginx add-on
3. **Use Tailscale Funnel** ‚Üí Independent public endpoint

**Recommended**: Test port 8096 first, fallback to reverse proxy if blocked

---

### Scenario 2: Expose Multiple Non-Standard Ports

**Requirement**: Multiple services (ports 8096, 8080, 3000) via custom domain

**Options**:
1. **Test each port** ‚Üí See which ports Nabu Casa routes
2. **Reverse proxy all** ‚Üí Map multiple paths to multiple ports
   - `/oauth/*` ‚Üí `music-assistant:8096`
   - `/grafana/*` ‚Üí `grafana:3000`
   - `/app/*` ‚Üí `custom-app:8080`

**Recommended**: Reverse proxy approach (predictable, maintainable)

---

### Scenario 3: Custom Domain with WebSocket Support

**Requirement**: WebSocket connections for real-time services

**Nabu Casa Support**: YES (WebSocket supported for port 8123)

**Configuration**:
- WebSocket connections to `wss://boxhillsouth.jasonhollis.com/api/websocket` work automatically
- No special configuration required
- Nabu Casa nginx includes WebSocket proxy headers

**For Non-Standard Ports**:
- If using reverse proxy (nginx add-on), add WebSocket headers:
  ```nginx
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  ```

---

## Performance Considerations

### Latency

**Nabu Casa Proxy Overhead**:
- **Expected**: 50-100ms additional latency
- **Factors**: Geographic distance to Nabu Casa proxy, internet connection quality
- **Impact**: Minimal for OAuth flows (infrequent requests)

**Reverse Proxy Overhead** (nginx add-on):
- **Expected**: <5ms additional latency (internal network)
- **Factors**: Home Assistant CPU load, Docker network overhead
- **Impact**: Negligible for most use cases

**Total Latency** (Nabu Casa + Reverse Proxy):
- **Request path**: Internet ‚Üí Nabu Casa ‚Üí HA ‚Üí nginx ‚Üí Music Assistant
- **Expected**: 55-105ms total overhead
- **Acceptable**: Yes (OAuth is not latency-sensitive)

---

### Throughput

**Nabu Casa Bandwidth**:
- **Limit**: Not publicly documented (assumed ~10-50 Mbps)
- **Use case**: Sufficient for OAuth requests (small payloads)
- **Concern**: NOT suitable for streaming media (large files)

**OAuth Request Size**:
- **Authorization**: ~2 KB (redirect with parameters)
- **Token exchange**: ~5 KB (JSON response)
- **Userinfo**: ~1 KB (JSON response)

**Bandwidth Impact**: Negligible (OAuth requests are small and infrequent)

---

## Security Considerations

### SSL/TLS

**Nabu Casa Certificate**:
- **Validation**: Full validation via Let's Encrypt
- **Encryption**: TLS 1.2+ (modern cipher suites)
- **HSTS**: Likely enabled by Nabu Casa (not user-configurable)

**Custom Domain Security**:
- ‚úÖ Valid SSL certificate (Let's Encrypt)
- ‚úÖ HTTPS enforced (HTTP redirects to HTTPS)
- ‚úÖ Trusted certificate authority (browser compatible)

---

### Authentication

**Nabu Casa Layer**:
- **Public endpoint**: No authentication at proxy layer
- **Subscription validation**: Handled in tunnel to HA instance
- **IP filtering**: Not supported (Nabu Casa is public)

**Application Layer**:
- **OAuth authentication**: Handled by Music Assistant OAuth server
- **Client credentials**: Stored in Music Assistant configuration
- **User authentication**: Required for OAuth authorization flow

**Recommendation**: Rely on application-layer auth (OAuth), not network-layer filtering

---

### Exposure Risks

**Public Endpoint Implications**:
- ‚ö†Ô∏è OAuth server accessible from internet (by design)
- ‚ö†Ô∏è Rate limiting required (prevent brute force)
- ‚ö†Ô∏è Strong client secrets required (prevent unauthorized access)
- ‚ö†Ô∏è Monitor access logs (detect suspicious activity)

**Mitigation**:
- OAuth server implements rate limiting (check Music Assistant config)
- Use strong, randomly generated client secrets
- Enable logging in Music Assistant OAuth server
- Consider IP-based rate limiting (if supported by OAuth server)

---

## Troubleshooting

### Custom Domain Not Resolving

**Symptom**: `curl https://boxhillsouth.jasonhollis.com/` times out

**Diagnosis**:
```bash
# Check DNS resolution
dig boxhillsouth.jasonhollis.com CNAME

# Expected: CNAME points to 0gdzommh4w1tug2s97xnn9spylzmkkbs.ui.nabu.casa
```

**Solutions**:
- DNS not propagated ‚Üí Wait 15-60 minutes, check TTL
- CNAME incorrect ‚Üí Verify in domain registrar settings
- Nabu Casa disconnected ‚Üí Check HA Cloud connection status

---

### Port 8096 Not Accessible

**Symptom**: `curl https://boxhillsouth.jasonhollis.com:8096/` connection refused

**Diagnosis**:
```bash
# Test internal connectivity
docker exec homeassistant curl -I http://music-assistant:8096/authorize

# Expected: 200 or 401 response
```

**Solutions**:
- Port blocked by Nabu Casa ‚Üí Implement reverse proxy (Workaround 1)
- Music Assistant not running ‚Üí Check container status, restart if needed
- OAuth server not configured ‚Üí Verify Music Assistant OAuth settings

---

### SSL Certificate Invalid

**Symptom**: Browser shows "Certificate not valid for :8096"

**Root Cause**: Nabu Casa certificate only valid for standard HTTPS port (443)

**Solution**: Use path-based routing instead of port-specific URLs
- Change: `https://boxhillsouth.jasonhollis.com:8096/oauth`
- To: `https://boxhillsouth.jasonhollis.com/oauth` (via reverse proxy)

---

## Quick Reference

### Port Routing Capabilities

| Feature | Port 8123 | Port 8096 | Notes |
|---------|-----------|-----------|-------|
| **HTTPS Access** | ‚úÖ Guaranteed | ‚ùì Unknown | Test required |
| **SSL Certificate** | ‚úÖ Valid | ‚ö†Ô∏è May fail | Port-specific cert issue |
| **WebSocket** | ‚úÖ Supported | ‚ùì Unknown | Requires testing |
| **Custom Domain** | ‚úÖ Yes | ‚ùì Unknown | Test required |
| **Zero Config** | ‚úÖ Yes | ‚ùå No | Likely requires proxy |

---

### Implementation Decision Matrix

| Requirement | Recommended Approach | Implementation Time |
|-------------|---------------------|---------------------|
| **Port 8123 only** | Direct Nabu Casa | 0 min (automatic) |
| **Port 8096 works** | Direct Nabu Casa + test | 5 min |
| **Port 8096 blocked** | Reverse proxy (nginx) | 15 min |
| **Multiple ports** | Reverse proxy (nginx) | 20 min |
| **Independent endpoint** | Tailscale Funnel | 15 min |
| **Custom paths** | Reverse proxy (nginx) | 15 min |

---

## See Also

- [Nabu Casa Custom Domain Test Plan](../05_OPERATIONS/NABU_CASA_CUSTOM_DOMAIN_TEST_PLAN.md) - Test procedures for port 8096
- [Nabu Casa vs Tailscale Decision Tree](../05_OPERATIONS/NABU_CASA_VS_TAILSCALE_DECISION_TREE.md) - Implementation paths
- [Tailscale Funnel Configuration](../05_OPERATIONS/TAILSCALE_FUNNEL_CONFIGURATION_HA.md) - Alternative approach
- [Home Assistant Container Topology](HOME_ASSISTANT_CONTAINER_TOPOLOGY.md) - Network architecture
- [Tailscale OAuth Routing Interface](../03_INTERFACES/TAILSCALE_OAUTH_ROUTING.md) - Routing contract (alternative)
